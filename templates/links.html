{% extends "layout.html" %}

{% block title %}
    {{ game.name }}
{% endblock %}

{% block body %}
<div class="form-panels-container">
    <div class="form-panel">
        {% if game.pre_download == "yes" %}
        <div class="message">{{ game.name }} Pre-Installation Links</div>
        {% else %}
        <div class="message">{{ game.name }} Download Links</div>
        {% endif %}
        <div class="form-container">
            <form action="/select">
                <button>Change Game</button>
            </form>
        </div>
    </div>
{% if game.biz == "bh3_global" %}
    <div class="form-panel">
        <div class="message">Game Files</div>
        <div>
            {% for part in game.links %}
                <div><a href="{{ part.major.game_pkgs[0].url }}">v{{ part.major.version }} File</a></div>
                <div>md5: {{ part.major.game_pkgs[0].md5 }}</div>
            {% endfor %}
        </div>
    </div>
{% else %}
<div class="form-panel">
    <div class="form-container">
        <form action="/links" method="post">
            <select name="full_update" id="download-type" onchange="updateLanguages()">
                <option value="" disabled selected>--- Full/Update ---</option>
                <option value="major">Full Game</option>
                <option value="patches">Update Only</option>
            </select>
            <select name="language" id="language-select">
                <option value="" disabled selected>--- Language ---</option>
            </select>
        </form>
    </div>
</div>
    <!-- <div class="form-panel">
        <div class="message">{{ game.links.major.version }} Full Game</div>
        <div class="another-panel">
            Game Files (all required)
            {% for part in game.links.major.game_pkgs %}
                <div><a href="{{ part.url }}">Part {{ part.url[-3:]|int }}</a></div>
                <div>md5: {{ part.md5 }}</div>
            {% endfor %}
        </div>
        <div class="another-panel">
            Voice-over Files (atleast 1 required)
            {% for langs in game.links.major.audio_pkgs %}
                <div><a href="{{ langs.url }}">{{ langs.language }}</a></div>
                <div>md5: {{ langs.md5 }}</div>
            {% endfor %}
        </div>
    </div>
    {% for update in game.links.patches %}
    <div class="form-panel">
        <div class="message">Update for v{{ update.version }}</div>
        <div class="another-panel">
            Game File
            <div><a href="{{ update.game_pkgs[0].url }}">Game</a></div>
            <div>md5: {{ update.game_pkgs[0].md5 }}</div>
        </div>
        <div class="another-panel">
            Voice-over Files (download the one you already have installed)
            {% for langs in update.audio_pkgs %}
                <div><a href="{{ langs.url }}">{{ langs.language }}</a></div>
                <div>md5: {{ langs.md5 }}</div>
            {% endfor %}
        </div>
    </div> -->
    {% endfor %}
{% endif %}
</div>
<script>
    // Extract the language data from the Jinja `game` variable
    const languageOptions = {
        major: {{ game.links.major.audio_pkgs | tojson }},
        patches: {{ game.links.patches | tojson }}
    };

    function updateLanguages() {
        const downloadType = document.getElementById("download-type").value;
        const languageSelect = document.getElementById("language-select");

        // Clear existing options
        languageSelect.innerHTML = '<option value="" disabled selected>--- Language ---</option>';

        // Populate options based on the selected download type
        if (languageOptions[downloadType]) {
            const audioPackages =
                downloadType === "patches"
                    ? languageOptions[downloadType].flatMap(patch => patch.audio_pkgs)
                    : languageOptions[downloadType];

            const uniqueLanguages = new Set(audioPackages.map(pkg => pkg.language));

            uniqueLanguages.forEach(language => {
                const option = document.createElement("option");
                option.value = language.toLowerCase();
                option.textContent = language;
                languageSelect.appendChild(option);
            });
        }
    }
</script>
{% endblock %}